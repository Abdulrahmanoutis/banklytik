{% extends 'base.html' %}

{% block title %}Preview Data - Banklytik{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Preview Your Transaction Data</h1>
                <div>
                    <a href="{% url 'statements:map_columns' statement.pk %}" class="btn btn-outline-secondary">
                        ‚Üê Back
                    </a>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Final Review</h5>
                    <p class="card-text">
                        Review your transaction data before saving. This is how it will appear in your Banklytik account.
                    </p>
                    <div class="alert alert-info">
                        <strong>Dataset Summary:</strong> {{ data_shape.0 }} transactions √ó {{ data_shape.1 }} columns
                    </div>
                </div>
            </div>

            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìù Transaction Preview - Editable</h5>
                    <small class="text-muted">Click any cell to edit ‚Ä¢ Changes saved automatically</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-bordered table-hover" id="editableTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    {% for key in final_data.0.keys %}
                                        <th class="editable-header">{{ key|title }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in final_data %}
                                    <tr data-row-id="{{ forloop.counter0 }}">
                                        <td class="text-muted small">{{ forloop.counter }}</td>
                                        {% for key, value in row.items %}
                                            <td class="editable-cell" data-field="{{ key }}" data-row="{{ forloop.parentloop.counter0 }}" title="Click to edit">
                                                <span class="cell-content">
                                                    {% if value %}
                                                        {{ value|truncatechars:50 }}
                                                    {% else %}
                                                        <span class="text-muted">‚Äî</span>
                                                    {% endif %}
                                                </span>
                                                <input type="text" class="form-control form-control-sm cell-input" style="display:none;" value="{{ value|default:'' }}">
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 alert alert-info">
                        <small>
                            <strong>üí° How to use:</strong> Click on any cell to edit it. The value will be updated immediately. 
                            Your changes will be saved when you click "Save Transactions".
                        </small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Column Mapping Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for field_name, field_label in field_labels %}
                            <div class="col-md-4 mb-2">
                                <strong>{{ field_label }}:</strong>
                                {% for col_name, mapped_field in column_mappings.items %}
                                    {% if mapped_field == field_name %}
                                        <span class="badge bg-primary">{{ col_name }}</span>
                                    {% endif %}
                                {% empty %}
                                    <span class="badge bg-secondary">Not mapped</span>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'statements:map_columns' statement.pk %}" class="btn btn-outline-secondary btn-lg">
                        Edit Column Mapping
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        ‚úÖ Save Transactions
                    </button>
                </div>
            </form>

            <div class="mt-3 alert alert-info">
                <p class="mb-0">
                    <strong>üí° Tip:</strong> After saving, you'll be able to ask AI questions about your transactions using our chat interface!
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store edited data for later saving
const editedData = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Preview page loaded - initializing editable cells');
    
    // Initialize all editable cells with event delegation
    const table = document.getElementById('editableTable');
    if (!table) {
        console.error('‚ùå Could not find #editableTable');
        return;
    }
    
    const editableCells = document.querySelectorAll('.editable-cell');
    console.log(`üìã Found ${editableCells.length} editable cells`);
    
    // Use event delegation on the table body
    const tbody = table.querySelector('tbody');
    if (tbody) {
        tbody.addEventListener('click', function(e) {
            // Check if clicked element or its parent is an editable cell
            let cell = e.target.closest('.editable-cell');
            if (!cell) return;
            
            // Don't trigger if clicking on input
            if (e.target.classList.contains('cell-input')) return;
            
            console.log(`üñ±Ô∏è Clicked on cell with field: ${cell.getAttribute('data-field')}`);
            enterEditMode(cell);
        });
    }
    
    // Also add direct listeners for safety
    editableCells.forEach((cell, index) => {
        cell.addEventListener('click', function(e) {
            if (e.target.classList.contains('cell-input')) return;
            console.log(`üñ±Ô∏è Direct click on cell ${index}`);
            enterEditMode(this);
        });
    });
    
    // Capture form submission to include edited data
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            collectEditedData();
            // Add hidden inputs for each edit
            Object.keys(editedData).forEach(key => {
                const [rowId, field] = key.split('_');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `edit_${rowId}_${field}`;
                input.value = editedData[key];
                form.appendChild(input);
            });
        });
    }
});

function enterEditMode(cell) {
    // Hide content, show input
    const content = cell.querySelector('.cell-content');
    const input = cell.querySelector('.cell-input');
    
    content.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
    
    // Handle blur (click outside or tab out)
    input.addEventListener('blur', function() {
        exitEditMode(cell);
    });
    
    // Handle Enter key
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            exitEditMode(cell);
        } else if (e.key === 'Escape') {
            // Revert changes
            input.value = content.innerText;
            exitEditMode(cell);
        }
    });
}

function exitEditMode(cell) {
    const content = cell.querySelector('.cell-content');
    const input = cell.querySelector('.cell-input');
    const rowId = cell.getAttribute('data-row');
    const field = cell.getAttribute('data-field');
    const newValue = input.value;
    
    // Update content display
    if (newValue.trim()) {
        content.innerText = newValue;
    } else {
        content.innerHTML = '<span class="text-muted">‚Äî</span>';
    }
    
    // Track edit
    const key = `${rowId}_${field}`;
    editedData[key] = newValue;
    
    // Visual feedback that cell was edited
    if (newValue !== content.getAttribute('data-original-value')) {
        cell.classList.add('table-warning');
    }
    
    // Hide input, show content
    input.style.display = 'none';
    content.style.display = 'inline';
}

function collectEditedData() {
    // Collect all edited values
    const editableCells = document.querySelectorAll('.editable-cell');
    editableCells.forEach(cell => {
        const input = cell.querySelector('.cell-input');
        const rowId = cell.getAttribute('data-row');
        const field = cell.getAttribute('data-field');
        const key = `${rowId}_${field}`;
        
        editedData[key] = input.value;
    });
    
    console.log('üìù Edited Data:', editedData);
}

// Add field labels for the mapping summary (keep this if needed)
const fieldLabels = [
    ['date', 'Date/Time'],
    ['description', 'Description'],
    ['debit', 'Debit Amount'],
    ['credit', 'Credit Amount'],
    ['amount', 'Transaction Amount'],
    ['balance', 'Balance'],
    ['reference', 'Reference']
];
</script>

<style>
.editable-cell {
    cursor: pointer;
    transition: background-color 0.2s;
}

.editable-cell:hover {
    background-color: #f0f7ff !important;
}

.editable-cell input {
    width: 100%;
}
</style>
{% endblock %}
