{% extends 'base.html' %}

{% block title %}Preview Data - Banklytik{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Preview Your Transaction Data</h1>
                <div>
                    <a href="{% url 'statements:map_columns' statement.pk %}" class="btn btn-outline-secondary">
                        ‚Üê Back
                    </a>
                </div>
            </div>
            
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}

            {% if validation_summary %}
            <div class="card mb-4 bg-light">
                <div class="card-header">
                    <h5 class="mb-0">üìä Data Validation Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6>Total Transactions</h6>
                            <h3>{{ validation_summary.total }}</h3>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-success">‚úÖ Valid</h6>
                            <h3 class="text-success">{{ validation_summary.valid }}</h3>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-warning">‚ö†Ô∏è Warnings</h6>
                            <h3 class="text-warning">{{ validation_summary.suspicious }}</h3>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-danger">‚ùå Errors</h6>
                            <h3 class="text-danger">{{ validation_summary.with_warnings }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìù Transaction Preview - Editable</h5>
                    <small class="text-muted">Click any cell to edit ‚Ä¢ OCR errors flagged below</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-bordered table-hover mb-0" id="editableTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    {% for key in final_data.0.keys %}
                                        {% if key not in 'row_issue,_date_validation,date_validation_issue,date_validation_warning' %}
                                            <th class="editable-header">{{ key|title }}</th>
                                        {% endif %}
                                    {% endfor %}
                                    <th style="width: 300px;">üîç Validation Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in final_data %}
                                    {% with warning_level=row.date_validation_warning|default:'INFO' %}
                                    <tr data-row-id="{{ forloop.counter0 }}" class="{% if warning_level == 'ERROR' %}table-danger{% elif warning_level == 'WARNING' %}table-warning{% endif %}">
                                        <td class="text-muted small">{{ forloop.counter }}</td>
                                        {% for key, value in row.items %}
                                            {% if key not in 'row_issue,_date_validation,date_validation_issue,date_validation_warning' %}
                                                <td class="editable-cell" data-field="{{ key }}" data-row="{{ forloop.parentloop.counter0 }}" title="Click to edit">
                                                    <span class="cell-content">
                                                        {% if value %}
                                                            {{ value }}
                                                        {% else %}
                                                            <span class="text-muted">‚Äî</span>
                                                        {% endif %}
                                                    </span>
                                                    <input type="text" class="form-control form-control-sm cell-input" style="display:none; width: 100%;" value="{{ value|default:'' }}">
                                                </td>
                                            {% endif %}
                                        {% endfor %}
                                        <td class="validation-cell" style="font-size: 0.85rem;">
                                            {% if warning_level == 'ERROR' %}
                                                <span class="badge bg-danger">‚ùå ERROR</span>
                                            {% elif warning_level == 'WARNING' %}
                                                <span class="badge bg-warning text-dark">‚ö†Ô∏è WARNING</span>
                                            {% else %}
                                                <span class="badge bg-success">‚úÖ VALID</span>
                                            {% endif %}
                                            <br>
                                            <small>{{ row.date_validation_issue|default:'No issues' }}</small>
                                        </td>
                                    </tr>
                                    {% endwith %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">
                            <strong>üí° OCR Validation:</strong> The system automatically detects OCR errors like impossible dates (e.g., "2025 Feb 20:42 59"). 
                            Red rows indicate critical errors, yellow rows indicate warnings. You can edit any cell to correct errors before saving.
                        </small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Column Mapping Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for field_name, field_label in field_labels %}
                            <div class="col-md-4 mb-2">
                                <strong>{{ field_label }}:</strong>
                                {% for col_name, mapped_field in column_mappings.items %}
                                    {% if mapped_field == field_name %}
                                        <span class="badge bg-primary">{{ col_name }}</span>
                                    {% endif %}
                                {% empty %}
                                    <span class="badge bg-secondary">Not mapped</span>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'statements:map_columns' statement.pk %}" class="btn btn-outline-secondary btn-lg">
                        Edit Column Mapping
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        ‚úÖ Save Transactions
                    </button>
                </div>
            </form>

            <div class="mt-3 alert alert-info">
                <p class="mb-0">
                    <strong>üí° Tip:</strong> After saving, you'll be able to ask AI questions about your transactions using our chat interface!
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Preview page loaded - initializing editable cells');
    
    const table = document.getElementById('editableTable');
    if (!table) {
        console.error('‚ùå Could not find #editableTable');
        return;
    }
    
    // Use event delegation on the table body
    const tbody = table.querySelector('tbody');
    if (tbody) {
        tbody.addEventListener('click', function(e) {
            let cell = e.target.closest('.editable-cell');
            if (!cell) return;
            
            if (e.target.classList.contains('cell-input')) return;
            
            console.log(`üñ±Ô∏è Clicked on cell with field: ${cell.getAttribute('data-field')}`);
            enterEditMode(cell);
        });
    }
    
    // Handle form submission
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Collect all edited values
            const editedCells = document.querySelectorAll('.editable-cell');
            editedCells.forEach(cell => {
                const input = cell.querySelector('.cell-input');
                const rowId = cell.getAttribute('data-row');
                const field = cell.getAttribute('data-field');
                const value = input.value;
                
                // Add hidden input for each cell
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = `edit_${rowId}_${field}`;
                hiddenInput.value = value;
                form.appendChild(hiddenInput);
            });
            
            console.log('üìù Form submitted with edited data');
        });
    }
});

function enterEditMode(cell) {
    const content = cell.querySelector('.cell-content');
    const input = cell.querySelector('.cell-input');
    
    content.style.display = 'none';
    input.style.display = 'block';
    input.focus();
    input.select();
    
    // Handle blur (click outside or tab out)
    input.addEventListener('blur', function() {
        exitEditMode(cell);
    });
    
    // Handle Enter key
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            exitEditMode(cell);
        } else if (e.key === 'Escape') {
            input.value = content.textContent;
            exitEditMode(cell);
        }
    });
}

function exitEditMode(cell) { 
    const content = cell.querySelector('.cell-content');
    const input = cell.querySelector('.cell-input');
    const newValue = input.value;
    
    // Update content display
    if (newValue.trim()) {
        content.textContent = newValue;
    } else {
        content.innerHTML = '<span class="text-muted">‚Äî</span>';
    }
    
    // Visual feedback that cell was edited
    cell.classList.add('table-warning');
    
    // Hide input, show content
    input.style.display = 'none';
    content.style.display = 'inline';
}
</script>

<style>
.editable-cell {
    cursor: pointer;
    transition: background-color 0.2s;
    position: relative;
}

.editable-cell:hover {
    background-color: #f8f9fa !important;
}

.editable-cell.table-warning {
    background-color: #fff3cd !important;
}

.cell-input {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 2px solid #007bff;
    border-radius: 4px;
}

.table th, .table td {
    vertical-align: middle;
    padding: 8px 12px;
}
</style>
{% endblock %}
